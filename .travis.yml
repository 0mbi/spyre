language: c
sudo: required
services:
  - docker
before_install:
  - docker pull debian:stretch-slim
  - pwd
  - docker run --name build --rm --detach --interactive --mount type=bind,src=`pwd`,dst=/build debian:stretch-slim /bin/sh
  - docker ps -a
  - docker exec -u root build apt-get -y update
  - docker exec -u root build apt-get --no-install-recommends -y install make gcc gcc-multilib gcc-mingw-w64 autoconf automake libtool pkg-config ca-certificates wget sed git-core golang-1.8-go golang-go moreutils zip
  - docker exec build ls -l /build
  # FIXME, this is almost curlbash
  - docker exec build wget -q -O /usr/local/bin/dep https://github.com/golang/dep/releases/download/v0.4.1/dep-linux-amd64
  - docker exec build chmod 755  /usr/local/bin/dep
script:
  - travis_wait 40 docker exec build /build/.travis-make.sh make release
after_failure:
  - tail -n 1000 .travis-make.log
deploy:
  provider: releases
  skip_cleanup: true
  overwrite: true
  api_key:
    secure:
  file-glob: true
  file: spyre-*.zip
  on:
    repo: spyre-project/spyre
    tags: true
